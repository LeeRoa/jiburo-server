<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Jiburo ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; padding: 20px; line-height: 1.6; }
        #chatBox { border: 2px solid #eee; height: 400px; overflow-y: auto; padding: 15px; background: #fff; margin-bottom: 10px; border-radius: 10px; }
        .msg-line { margin-bottom: 8px; }
        .nickname { font-weight: bold; color: #ff6b6b; margin-right: 5px; }
        .content { background: #f1f3f5; padding: 5px 10px; border-radius: 10px; }
        .system { color: #888; font-size: 0.9em; font-style: italic; text-align: center; display: block; margin: 10px 0; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>ğŸ¾ Jiburo ì‹¤ì‹œê°„ ì±„íŒ…</h2>
    
    <div style="margin-bottom: 15px;">
        <input type="text" id="roomId" placeholder="ë°© Hash ID ì…ë ¥" style="width:200px;">
        <button onclick="connect()">1. ì„œë²„ ì—°ê²°</button>
    </div>
    
    <div id="chatBox">
        <span class="system">ì„œë²„ì— ì—°ê²°í•˜ë©´ ëŒ€í™” ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
    </div>
    
    <div style="display: flex; gap: 5px;">
        <input type="text" id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex-grow: 1;" onkeypress="if(event.keyCode==13) sendMessage()">
        <button onclick="sendMessage()">2. ì „ì†¡</button>
    </div>

    <script>
        let stompClient = null;

        function connect() {
            const roomId = document.getElementById('roomId').value;
            if(!roomId) return alert("ë°© IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ì„œë²„ ì£¼ì†Œ
            const socket = new WebSocket('ws://localhost:8080/ws-jiburo');
            stompClient = Stomp.over(socket);

            // ì—°ê²° ì‹œë„
            stompClient.connect({}, function (frame) {
                printLog("ì‹œìŠ¤í…œ", "ğŸŸ¢ ì—°ê²° ì„±ê³µ! [" + roomId + "] ë°©ì„ êµ¬ë…í•©ë‹ˆë‹¤.");
                
                // êµ¬ë… ì„¤ì •
                stompClient.subscribe('/sub/chat/rooms/' + roomId, function (response) {
                    const data = JSON.parse(response.body);
                    printLog(data.senderNickname || "ìµëª…", data.content);
                });
            }, function(error) {
                printLog("ì‹œìŠ¤í…œ", "ğŸ”´ ì—ëŸ¬ ë°œìƒ: " + error);
            });
        }

        function sendMessage() {
            const roomId = document.getElementById('roomId').value;
            const content = document.getElementById('message').value;
            if(!stompClient || !content) return;

            const payload = {
                content: content,
                messageTypeCode: "TALK"
            };

            // STOMP ë°œí–‰
            stompClient.send("/pub/chat/rooms/" + roomId, {}, JSON.stringify(payload));
            document.getElementById('message').value = '';
        }

        function printLog(sender, text) {
            const chatBox = document.getElementById('chatBox');
            if(sender === "ì‹œìŠ¤í…œ") {
                chatBox.innerHTML += `<span class="system">${text}</span>`;
            } else {
                chatBox.innerHTML += `<div class="msg-line"><span class="nickname">${sender}:</span><span class="content">${text}</span></div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>