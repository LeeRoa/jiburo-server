<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Jiburo ì±„íŒ…ë°© ğŸ¾</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        :root { --bg: #A2B9CF; --me: #FEE500; --other: #FFFFFF; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; padding: 20px; }

        /* [UI] ì„¤ì • íŒ¨ë„ */
        .panel { background: white; padding: 25px; border-radius: 20px; width: 380px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 12px; }
        input { padding: 14px; border: 1px solid #eee; border-radius: 10px; outline: none; font-size: 14px; }
        input:focus { border-color: #556677; }
        .btn-primary { padding: 14px; background: #556677; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { background: #334455; }

        /* [UI] ì±„íŒ… ë·° */
        #chatView { display: none; width: 400px; flex-direction: column; height: 100%; }
        #chatBox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 14px; }

        /* [UI] ë§í’ì„  ë””ìì¸ */
        .msg-wrap { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .nickname { font-size: 12px; color: #444; margin: 0 4px 4px; font-weight: 600; }
        .bubble { padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4; color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* ë‚´ ë©”ì‹œì§€ (ìš°ì¸¡) */
        .my { align-self: flex-end; align-items: flex-end; }
        .my .bubble { background: var(--me); border-top-right-radius: 2px; }
        .my .nickname { display: none; } /* ë‚´ ë‹‰ë„¤ì„ì€ ìˆ¨ê¹€ */

        /* ìƒëŒ€ ë©”ì‹œì§€ (ì¢Œì¸¡) */
        .other { align-self: flex-start; align-items: flex-start; }
        .other .bubble { background: var(--other); border-top-left-radius: 2px; }

        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
        .system { align-self: center; background: rgba(0,0,0,0.15); color: white; padding: 5px 15px; border-radius: 20px; font-size: 11px; margin: 10px 0; }

        /* [UI] ì „ì†¡ë°” */
        .send-bar { background: white; padding: 15px; display: flex; gap: 10px; border-radius: 15px; margin-top: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        #msgInput { flex: 1; border: none; background: #f0f0f0; }
    </style>
</head>
<body>

<div id="configPanel" class="panel">
    <h3 style="margin:0 0 10px; text-align:center; color:#556677;">Jiburo Login ğŸ¾</h3>
    <input type="text" id="token" placeholder="JWT Token (Bearer ì œì™¸)">
    <input type="text" id="roomId" placeholder="Room ID (Hashid)">
    <button class="btn-primary" onclick="ChatApp.connect()">ì±„íŒ…ë°© ì…ì¥</button>
</div>

<div id="chatView">
    <div id="chatBox"></div>
    <div class="send-bar">
        <input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) ChatApp.send()">
        <button onclick="ChatApp.send()" style="border:none; background:var(--me); padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">ì „ì†¡</button>
        <button onclick="location.reload()" style="border:none; background:none; color:#ff4d4f; cursor:pointer; font-size:12px;">ë‚˜ê°€ê¸°</button>
    </div>
</div>

<script>
    /**
     * ChatApp ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë¡œì§ ê·¸ë£¹í™” (ë¦¬íŒ©í† ë§)
     */
    const ChatApp = {
        stompClient: null,
        myUserId: null, // ë‚´ UUID ì €ì¥
        currentRoomId: null,

        // 1. JWT íŒŒì‹± ë° ìœ ì € UUID ì¶”ì¶œ
        parseJwt: function(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(window.atob(base64));
            } catch (e) {
                console.error("JWT íŒŒì‹± ì—ëŸ¬:", e);
                return null;
            }
        },

        // 2. ì—°ê²° ë¡œì§
        connect: function() {
            const token = document.getElementById('token').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            const payload = this.parseJwt(token);

            if (!payload || !roomId) {
                alert("í† í°ê³¼ ë°© IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            // [í•µì‹¬] ë‚´ IDë¥¼ í† í°ì˜ sub(UUID)ì—ì„œ ì¶”ì¶œ
            this.myUserId = payload.sub;
            this.currentRoomId = roomId;

            const socket = new WebSocket('ws://localhost:8080/ws-jiburo');
            this.stompClient = Stomp.over(socket);
            this.stompClient.debug = null; // ì½˜ì†” ì§€ì €ë¶„í•˜ë©´ null

            const headers = { 'Authorization': 'Bearer ' + token };

            this.stompClient.connect(headers, (frame) => {
                this.onConnected();
            }, (err) => {
                alert("ì—°ê²° ì‹¤íŒ¨: " + err);
            });
        },

        // 3. ì—°ê²° ì„±ê³µ í›„ ì²˜ë¦¬
        onConnected: function() {
            document.getElementById('configPanel').style.display = 'none';
            document.getElementById('chatView').style.display = 'flex';

            this.appendSystem(`ğŸŸ¢ ì ‘ì† ì„±ê³µ (ID: ${this.myUserId.split('-')[0]}...)`);

            // êµ¬ë… ì„¤ì •
            this.stompClient.subscribe('/sub/chat/rooms/' + this.currentRoomId, (res) => {
                const data = JSON.parse(res.body);

                // [í•µì‹¬] ë‹‰ë„¤ì„ì´ ì•„ë‹Œ UUID(senderId)ë¡œ ë‚´ ë©”ì‹œì§€ì¸ì§€ íŒë³„
                const isMine = (data.senderId === this.myUserId);

                this.appendBubble(data.senderNickname, data.content, isMine);
            });
        },

        // 4. ë©”ì‹œì§€ ë°œí–‰
        send: function() {
            const msgInput = document.getElementById('msgInput');
            const content = msgInput.value.trim();

            if (!content || !this.stompClient) return;

            const payload = {
                content: content,
                messageTypeCode: "TALK"
            };

            this.stompClient.send("/pub/chat/rooms/" + this.currentRoomId, {}, JSON.stringify(payload));
            msgInput.value = '';
            msgInput.focus();
        },

        // 5. UI ë Œë”ë§ í•¨ìˆ˜ë“¤
        appendBubble: function(nick, content, isMine) {
            const box = document.getElementById('chatBox');
            const sideClass = isMine ? 'my' : 'other';

            const html = `
                <div class="msg-wrap ${sideClass}">
                    <div class="nickname">${nick}</div>
                    <div class="bubble">${content}</div>
                </div>
            `;
            box.insertAdjacentHTML('beforeend', html);
            box.scrollTop = box.scrollHeight;
        },

        appendSystem: function(txt) {
            const box = document.getElementById('chatBox');
            box.insertAdjacentHTML('beforeend', `<div class="system">${txt}</div>`);
        }
    };
</script>
</body>
</html>
